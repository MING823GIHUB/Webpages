<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>屏東縣東港鎮和美街即時天氣</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 載入 Babel，用於轉換 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* 自訂字體，確保中文字體顯示正常 */
        body {
            font-family: 'Inter', 'Noto Sans CJK TC', sans-serif;
        }
        /* 由於瀏覽器安全限制，無法完全禁止使用者檢視原始碼。
           此為前端網頁，所有程式碼最終都會載入至使用者的瀏覽器。 */
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 主應用程式組件
        const App = () => {
            // 從 React 全局物件中解構 useState 和 useEffect
            const { useState, useEffect, useRef, useCallback } = React;

            // 狀態變數：儲存天氣資料
            const [weatherData, setWeatherData] = useState(null);
            // 狀態變數：儲存載入狀態
            const [loading, setLoading] = useState(true);
            // 狀態變數：儲存錯誤訊息
            const [error, setError] = useState(null);
            // 新增狀態變數：儲存現在時刻
            const [currentTime, setCurrentTime] = useState('');

            // 用於整點報時的 Ref 和狀態
            const lastChimeHourRef = useRef(-1); // 使用 useRef 儲存上次報時的小時，避免重複報時
            const chimeAudioRef = useRef(null); // 使用 useRef 儲存音訊元素

            // OpenWeatherMap API Key
            // 請在這裡填入你的 OpenWeatherMap API Key
            const API_KEY = "c3a279983235d57dc69818ffffe9a265";

            // 屏東縣東港鎮和美街的近似經緯度 (從東港鎮的座標更新)
            const LATITUDE = 22.466667; // 約 22°28′00″N
            const LONGITUDE = 120.454444; // 約 120°27′16″E

            // 獲取天氣資料的函數，使用 useCallback 包裹以優化性能
            const fetchWeatherData = useCallback(async () => {
                if (!API_KEY) {
                    setError("請在程式碼中填入你的 OpenWeatherMap API Key。");
                    setLoading(false);
                    return;
                }

                setLoading(true); // 開始獲取資料時顯示載入中
                setError(null); // 清除之前的錯誤訊息

                // OpenWeatherMap API 網址
                const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${LATITUDE}&lon=${LONGITUDE}&appid=${API_KEY}&units=metric&lang=zh_tw`;

                try {
                    // 嘗試進行 API 呼叫 (包含指數退避機制)
                    let response;
                    let data;
                    let retries = 0;
                    const MAX_RETRIES = 5;
                    const BASE_DELAY = 1000; // 1 second

                    while (retries < MAX_RETRIES) {
                        response = await fetch(apiUrl);
                        if (response.ok) {
                            data = await response.json();
                            break; // Success, exit loop
                        } else if (response.status === 429) { // Too Many Requests
                            const delay = BASE_DELAY * Math.pow(2, retries);
                            console.warn(`API Rate limit hit. Retrying in ${delay / 1000} seconds...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retries++;
                        } else if (response.status === 401) { // Unauthorized error
                            // 更明確的錯誤訊息
                            throw new Error("API Key 無效或尚未啟用。請確認您的 OpenWeatherMap API Key 是否正確且已啟用。");
                        }
                        else {
                            // Other HTTP errors
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }

                    if (!response.ok) {
                        throw new Error(`無法獲取天氣資料: ${response.statusText}`);
                    }

                    // 處理 API 回傳的資料
                    const weatherCondition = data.weather[0].description;
                    const temperature = data.main.temp.toFixed(1); // 溫度取一位小數
                    const humidity = data.main.humidity;
                    const windSpeed = (data.wind.speed * 3.6).toFixed(1); // 從 m/s 轉換為 km/h
                    const windDeg = data.wind.deg;

                    // 判斷風向
                    const getWindDirection = (deg) => {
                        const directions = ['北', '東北', '東', '東南', '南', '西南', '西', '西北'];
                        const index = Math.round((deg % 360) / 45);
                        return directions[index % 8];
                    };

                    // 判斷是否下雨 (簡化判斷，可根據需求擴展)
                    const isRaining = data.weather[0].main === 'Rain' || data.weather[0].main === 'Drizzle';
                    const precipitationAmount = isRaining ? "有降水" : "0.0 mm"; // OpenWeatherMap current data doesn't directly provide current mm

                    setWeatherData({
                        condition: weatherCondition,
                        temperature: `${temperature}°C`,
                        humidity: `${humidity}%`,
                        precipitation: precipitationAmount,
                        windSpeed: `${windSpeed} 公里/小時`,
                        windDirection: `${getWindDirection(windDeg)} (${windDeg}°)`,
                        isRaining: isRaining,
                        timestamp: new Date().toLocaleString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }).replace(/\//g, '-')
                    });
                } catch (err) {
                    console.error("獲取天氣資料失敗:", err);
                    setError(`無法獲取天氣資料，請稍後再試。錯誤: ${err.message}`);
                } finally {
                    setLoading(false);
                }
            }, [API_KEY]); // 依賴 API_KEY

            // 使用 useEffect 鉤子在組件載入時獲取天氣資料並設定自動更新
            useEffect(() => {
                fetchWeatherData(); // 首次載入時立即獲取資料

                // 每 10 分鐘更新一次資料 (600000 毫秒)
                const intervalId = setInterval(fetchWeatherData, 600000);

                // 清理函數：在組件卸載時清除定時器
                return () => clearInterval(intervalId);
            }, [fetchWeatherData]); // 依賴 fetchWeatherData

            // 新增 useEffect 鉤子來更新現在時刻和處理整點報時
            useEffect(() => {
                // 初始化音訊元素（只執行一次）
                if (!chimeAudioRef.current) {
                    chimeAudioRef.current = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-01.mp3');
                    chimeAudioRef.current.volume = 0.7; // 設定報時音量
                }

                const updateCurrentTimeAndChime = () => {
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    const currentSecond = now.getSeconds();

                    // 更新現在時刻顯示
                    setCurrentTime(now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    }).replace(/\//g, '-'));

                    // 整點報時邏輯：在每個小時的開始（例如 00 分 00 秒到 05 秒之間）播放
                    // 並且確保每個小時只報時一次
                    if (currentMinute === 0 && currentSecond >= 0 && currentSecond < 5) {
                        if (currentHour !== lastChimeHourRef.current) {
                            if (chimeAudioRef.current) {
                                chimeAudioRef.current.play().catch(e => {
                                    console.error("播放報時音效失敗:", e);
                                    // 提示使用者需要互動才能播放音效
                                    setError("音效可能因瀏覽器政策被阻擋，請點擊頁面任意處啟用音效。");
                                });
                            }
                            lastChimeHourRef.current = currentHour; // 更新上次報時的小時
                        }
                    } else if (currentMinute === 59 && currentSecond > 55) {
                        // 在每個小時結束前重置 lastChimeHourRef，以便下個小時能再次報時
                        lastChimeHourRef.current = -1;
                    }
                };

                updateCurrentTimeAndChime(); // 首次載入時更新
                const timeIntervalId = setInterval(updateCurrentTimeAndChime, 1000); // 每秒更新

                // 清理函數：在組件卸載時清除定時器
                return () => clearInterval(timeIntervalId);
            }, []); // 空依賴陣列表示只在組件掛載和卸載時執行

            // 手動更新按鈕的點擊處理函數
            const handleManualUpdate = () => {
                fetchWeatherData(); // 呼叫獲取天氣資料的函數
            };

            // 載入中狀態顯示
            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50"> {/* 更改背景色 */}
                        <div className="text-xl font-semibold text-blue-700">載入中...</div>
                    </div>
                );
            }

            // 錯誤狀態顯示
            if (error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-red-100">
                        <div className="text-xl font-semibold text-red-700 p-4 rounded-lg shadow-md bg-white">
                            錯誤: {error}
                            {error.includes("瀏覽器政策") && (
                                <p className="text-sm mt-2 text-gray-600">
                                    請點擊頁面任意處或音訊播放器以啟用音效。
                                </p>
                            )}
                        </div>
                    </div>
                );
            }

            // 當沒有天氣資料時 (例如 API Key 錯誤或首次載入失敗)
            if (!weatherData) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-xl font-semibold text-gray-700 p-4 rounded-lg shadow-md bg-white">
                            無法顯示天氣資料。請檢查您的 API Key 或稍後再試。
                        </div>
                    </div>
                );
            }

            // 渲染天氣資訊
            return (
                <div className="min-h-screen flex items-center justify-center p-4 sm:p-6 bg-gray-50 font-inter"> {/* 更改背景色 */}
                    <div className="bg-white rounded-2xl shadow-xl p-6 sm:p-8 md:p-10 max-w-md w-full border-b-4 border-blue-500">
                        <h2 className="text-2xl sm:text-3xl font-bold text-blue-700 text-center mb-6">
                            屏東縣東港鎮和美街週邊即時天氣
                        </h2>

                        {/* 現在時刻顯示 */}
                        <div className="text-center text-xl sm:text-2xl font-semibold text-gray-700 mb-4">
                            現在時刻：<span className="font-bold text-blue-600">{currentTime}</span>
                        </div>

                        <div className={`text-center text-2xl sm:text-3xl font-extrabold mb-5 py-2 rounded-lg ${
                            weatherData.isRaining ? 'text-blue-600 bg-blue-50' : 'text-red-600 bg-red-50'
                        }`}>
                            {weatherData.isRaining ? '目前正在下雨！' : '目前不會下雨！'}
                        </div>

                        <div className="space-y-3 text-lg sm:text-xl text-gray-800">
                            {/* 天氣狀況換行調整 */}
                            <p className="flex flex-col items-start pb-2 border-b border-gray-200">
                                <span className="font-semibold text-gray-600 mb-1">天氣狀況：</span>
                                <span className="text-right w-full">{weatherData.condition}</span>
                            </p>
                            <p className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="font-semibold text-gray-600">溫度：</span>
                                <span>{weatherData.temperature}</span>
                            </p>
                            <p className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="font-semibold text-gray-600">相對濕度：</span>
                                <span>{weatherData.humidity}</span>
                            </p>
                            <p className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="font-semibold text-gray-600">降水量：</span>
                                <span>{weatherData.precipitation}</span>
                            </p>
                            <p className="flex justify-between items-center pb-2 border-b border-gray-200">
                                <span className="font-semibold text-gray-600">風速：</span>
                                <span>{weatherData.windSpeed}</span>
                            </p>
                            <p className="flex justify-between items-center">
                                <span className="font-semibold text-gray-600">風向：</span>
                                <span>{weatherData.windDirection}</span>
                            </p>
                        </div>

                        <div className="text-sm sm:text-base text-gray-500 text-center mt-6 pt-4 border-t border-gray-200">
                            天氣資料更新時間：<span className="font-medium">{weatherData.timestamp}</span>
                        </div>

                        {/* 手動更新按鈕 */}
                        <div className="mt-6 text-center">
                            <button
                                onClick={handleManualUpdate}
                                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50"
                            >
                                手動更新天氣
                            </button>
                        </div>

                        {/* 背景音樂控制 */}
                        <div className="mt-6 text-center">
                            <audio controls loop>
                                {/* 更換為柔和的音樂檔案路徑 */}
                                <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" type="audio/mpeg" />
                                您的瀏覽器不支援音訊元素。
                            </audio>
                            <p className="text-xs text-gray-400 mt-2">
                                (背景音樂：已更換為較柔和的範例音樂)
                            </p>
                             <p className="text-xs text-red-500 mt-2">
                                提醒：音效可能因瀏覽器自動播放政策被阻擋，請點擊頁面任意處或音訊播放器以啟用音效。
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // 將 React 應用程式渲染到 HTML 頁面中
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
